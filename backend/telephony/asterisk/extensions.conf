; ============================================================================
; Asterisk Dialplan for VCA Platform - Inbound Call Routing
; ============================================================================
;
; PURPOSE:
; This dialplan handles inbound calls from Tata SIP trunk and routes them
; to the VCA platform's FastAPI backend for AI-powered call handling.
;
; ARCHITECTURE FLOW:
; 1. Tata SIP trunk receives inbound call on a DID number
; 2. Call arrives in Asterisk via pjsip.conf trunk configuration
; 3. This dialplan captures call metadata (caller ID, DID, etc.)
; 4. Dialplan makes HTTP POST to VCA FastAPI endpoint: /internal/telephony/inbound
; 5. VCA backend resolves DID to tenant, creates Call record
; 6. Future: VCA backend would initiate AI conversation loop (TODO)
;
; ⚠️  SECURITY NOTES:
; - This dialplan exposes no secrets (all are in pjsip.conf)
; - DID routing is tenant-isolated in VCA backend
; - The /internal endpoint should be restricted to localhost only
; - Production deployments must secure the HTTP communication
;
; For detailed documentation, see BACKEND_README.md

; ============================================================================
; GLOBAL SETTINGS
; ============================================================================
[general]
static=yes
writeprotect=no
clearglobalvars=no

; ============================================================================
; CONTEXT: from-tata-trunk
; ============================================================================
; This context handles ALL inbound calls from the Tata SIP trunk.
; The context name MUST match the "context=" setting in pjsip.conf [tata-trunk]

[from-tata-trunk]

; ----------------------------------------------------------------------------
; Priority 1: Answer the call immediately
; ----------------------------------------------------------------------------
; We answer early to start billing and establish media path
exten => _X.,1,NoOp(=== VCA Inbound Call Start ===)
same => n,NoOp(Caller: ${CALLERID(num)} -> DID: ${EXTEN})
same => n,Answer()
; ⚠️  Note: Early answer means billing starts here. Adjust if Tata bills differently.

; ----------------------------------------------------------------------------
; Priority 2: Set call variables for logging and tracking
; ----------------------------------------------------------------------------
same => n,Set(CALL_ID=${UNIQUEID})
; UNIQUEID is Asterisk's unique identifier for this call
same => n,Set(CALLER_NUMBER=${CALLERID(num)})
; Caller's phone number (ANI - Automatic Number Identification)
same => n,Set(CALLED_NUMBER=${EXTEN})
; Called DID number (DNIS - Dialed Number Identification Service)
same => n,Set(CALL_TIMESTAMP=${EPOCH})
; Unix timestamp when call started
same => n,NoOp(Call ID: ${CALL_ID}, Timestamp: ${CALL_TIMESTAMP})

; ----------------------------------------------------------------------------
; Priority 3: Normalize caller number (remove any + prefix if present)
; ----------------------------------------------------------------------------
same => n,Set(NORMALIZED_CALLER=${IF($[${CALLERID(num):0:1} = +]?${CALLERID(num):1}:${CALLERID(num)})})
same => n,NoOp(Normalized Caller: ${NORMALIZED_CALLER})

; ----------------------------------------------------------------------------
; Priority 4: POST call metadata to VCA backend endpoint
; ----------------------------------------------------------------------------
; This is the critical integration point between Asterisk and VCA platform.
; The CURL function makes an HTTP POST to the FastAPI backend.
;
; ⚠️  SECURITY: This endpoint should be localhost-only or properly secured
; ⚠️  TODO: Add authentication token/header in production
; ⚠️  TODO: Configure VCA_BACKEND_URL from environment or config file

same => n,Set(VCA_BACKEND_URL=http://localhost:8000/internal/telephony/inbound)
; TODO: Production - load this from a config file or environment variable
; TODO: Production - use HTTPS if backend is on different server
; TODO: Production - add network retry logic

same => n,Set(CURLOPT(httptimeout)=5)
; 5-second timeout for the HTTP request
; TODO: Adjust timeout based on expected backend response time

same => n,Set(POST_DATA={"caller_number":"${NORMALIZED_CALLER}","called_number":"${CALLED_NUMBER}","call_id":"${CALL_ID}","timestamp":"${CALL_TIMESTAMP}"})
; JSON payload with call metadata
; Backend will use called_number (DID) to resolve tenant_id

same => n,NoOp(Posting to VCA: ${POST_DATA})
same => n,Set(CURL_RESULT=${CURL(${VCA_BACKEND_URL},${POST_DATA})})
; Makes the HTTP POST request and stores response in CURL_RESULT
same => n,NoOp(VCA Response: ${CURL_RESULT})

; ----------------------------------------------------------------------------
; Priority 5: Check VCA backend response
; ----------------------------------------------------------------------------
; The backend should return JSON with status and call_record_id
; Example: {"status": "success", "call_record_id": "uuid-here"}

same => n,GotoIf($["${CURL_RESULT}" = ""]?vca_error)
; If CURL_RESULT is empty, backend didn't respond - go to error handling

same => n,NoOp(VCA backend accepted call, call_record_id in response)
; TODO: Parse call_record_id from JSON response for future use
; TODO: Store call_record_id in Asterisk DB or channel variable

; ----------------------------------------------------------------------------
; Priority 6: Play holding message while AI initializes
; ----------------------------------------------------------------------------
; TODO: This is a placeholder for the AI conversation loop
; TODO: Future implementation will:
; - Establish WebRTC or media stream to AI service
; - Stream audio bidirectionally (STT + TTS)
; - Handle DTMF input if needed
; - Process call events (hold, transfer, hangup)

same => n,NoOp(=== TODO: Initialize AI Conversation Loop ===)
same => n,Playback(silence/1)
; Play 1 second of silence as placeholder
; TODO: Replace with actual AI conversation handling

; TODO: Future AI integration points:
; 1. POST audio stream to STT service
; 2. Send transcribed text to LLM service
; 3. Receive LLM response
; 4. POST text to TTS service
; 5. Stream TTS audio back to caller
; 6. Loop until call ends

same => n,NoOp(=== TODO: AI Loop Would Run Here ===)
same => n,Wait(2)
; Placeholder wait - in production, this would be the AI conversation

; ----------------------------------------------------------------------------
; Priority 7: Call completion
; ----------------------------------------------------------------------------
same => n,NoOp(=== VCA Call Ending ===)
same => n,Hangup()
; Terminate the call gracefully

; ----------------------------------------------------------------------------
; Error Handling: VCA backend unreachable or error
; ----------------------------------------------------------------------------
same => n(vca_error),NoOp(=== ERROR: VCA Backend Unreachable ===)
same => n,NoOp(Could not connect to VCA backend at ${VCA_BACKEND_URL})
; Log error for troubleshooting

; TODO: Production - implement fallback behavior:
; - Play "service temporarily unavailable" message
; - Or: Route to emergency voicemail
; - Or: Route to backup queue
; - Always log the failure for operations team

same => n,Playback(silence/1)
; Placeholder - replace with actual error message
same => n,NoOp(=== TODO: Play Error Message to Caller ===)
same => n,Hangup()
; Hangup after error

; ============================================================================
; CONTEXT: Catch-all for undefined extensions (safety net)
; ============================================================================
[from-tata-trunk-invalid]
exten => _X.,1,NoOp(=== Invalid Extension Dialed ===)
same => n,NoOp(Extension ${EXTEN} not configured)
same => n,Hangup()

; ============================================================================
; PRODUCTION DEPLOYMENT CHECKLIST
; ============================================================================
; Before deploying to production, ensure:
;
; [ ] VCA_BACKEND_URL points to correct backend endpoint
; [ ] Backend endpoint is secured (localhost-only or authenticated)
; [ ] Network connectivity tested between Asterisk and VCA backend
; [ ] Error handling messages recorded and configured
; [ ] Logging configured for all call stages
; [ ] Asterisk dialplan reloaded: asterisk -rx "dialplan reload"
; [ ] Test calls made through full stack (Tata -> Asterisk -> VCA)
; [ ] Call quality monitoring enabled
; [ ] Failover/fallback behavior implemented
; [ ] TODO items addressed for AI conversation loop
;
; ⚠️  For security and architecture details, see BACKEND_README.md
